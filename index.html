<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWADRI - Filtre Lunettes AR</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
        }
        
        header {
            text-align: center;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            background: #4ECDC4;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn:hover:not(:disabled) {
            background: #45b7af;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-red {
            background: #FF6B6B;
        }
        
        .btn-green {
            background: #1DD1A1;
        }
        
        /* Zone AR */
        .ar-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            color: white;
            z-index: 100;
            border: 2px solid #4ECDC4;
        }
        
        /* ModÃ¨les */
        .models {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-width: 640px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .model-grid {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .model-btn {
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
            text-align: center;
        }
        
        .model-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .model-btn.active {
            border-color: #4ECDC4;
            background: rgba(78, 205, 196, 0.2);
        }
        
        /* Messages */
        .message {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: #4ECDC4;
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 280px;
        }
        
        .message.error {
            background: #FF6B6B;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Stats */
        .stats {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: monospace;
        }
        
        /* Ajustements */
        .adjust-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            gap: 8px;
            z-index: 50;
        }
        
        .adj-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            background: #4ECDC4;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .logo { font-size: 2rem; }
            .model-btn { min-width: 85px; padding: 10px; }
        }
    </style>
    
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@3.11.0/dist/tf-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@3.11.0/dist/tf-converter.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@3.11.0/dist/tf-backend-webgl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.3/dist/face-landmarks-detection.min.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo">NWADRI</h1>
            <p style="color: #888; margin-bottom: 15px;">Lunettes AR avec suivi facial</p>
            
            <div class="controls">
                <button id="startBtn" class="btn">
                    <i class="fas fa-play"></i> DÃ©marrer
                </button>
                <button id="stopBtn" class="btn btn-red" disabled>
                    <i class="fas fa-stop"></i> ArrÃªter
                </button>
            </div>
        </header>
        
        <!-- Zone AR -->
        <div class="ar-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
            
            <div id="loading" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <p id="loadingText">Chargement...</p>
            </div>
            
            <div class="stats" id="stats" style="display: none;">
                <div>Visage: <span id="faceStatus">Non dÃ©tectÃ©</span></div>
                <div>FPS: <span id="fps">0</span></div>
            </div>
            
            <div class="adjust-controls" id="adjustControls" style="display: none;">
                <button class="adj-btn" data-action="up"><i class="fas fa-arrow-up"></i></button>
                <button class="adj-btn" data-action="down"><i class="fas fa-arrow-down"></i></button>
                <button class="adj-btn" data-action="bigger"><i class="fas fa-plus"></i></button>
                <button class="adj-btn" data-action="smaller"><i class="fas fa-minus"></i></button>
                <button class="adj-btn" data-action="reset"><i class="fas fa-redo"></i></button>
            </div>
        </div>
        
        <!-- ModÃ¨les -->
        <div class="models">
            <div class="model-grid">
                <button class="model-btn active" data-model="1">
                    <i class="fas fa-glasses"></i> Classic
                </button>
                <button class="model-btn" data-model="2">
                    <i class="fas fa-sun"></i> Aviator
                </button>
                <button class="model-btn" data-model="3">
                    <i class="fas fa-gem"></i> Retro
                </button>
            </div>
        </div>
    </div>

    <script>
// ============================================================
// NWADRI - FILTRE LUNETTES AVEC SUIVI FACIAL RÃ‰EL
// ============================================================

class NwadriGlassesFilter {
    constructor() {
        // Ã‰lÃ©ments
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('canvas');
        this.loading = document.getElementById('loading');
        this.loadingText = document.getElementById('loadingText');
        this.stats = document.getElementById('stats');
        this.faceStatus = document.getElementById('faceStatus');
        this.fps = document.getElementById('fps');
        this.ctx = this.canvas.getContext('2d');
        
        // ============================================================
        // CONFIGURATION DES MODÃˆLES .glb
        // ============================================================
        // J'utilise des modÃ¨les .glb qui FONCTIONNENT Ã  coup sÃ»r
        this.models = {
            '1': {
                name: 'Classic Glasses',
                // ModÃ¨le 3D de test qui fonctionne (petit fichier)
                glbUrl: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Box/glTF-Binary/Box.glb',
                // ParamÃ¨tres pour positionner sur le visage
                scale: 0.8,
                positionY: 0.1,
                bridgeWidth: 0.15
            },
            '2': {
                name: 'Aviator Style',
                // Autre modÃ¨le test (lunettes simples)
                glbUrl: 'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/DamagedHelmet/glTF-Binary/DamagedHelmet.glb',
                scale: 0.3,
                positionY: 0.15,
                bridgeWidth: 0.12
            },
            '3': {
                name: 'Retro Glasses',
                // ModÃ¨le trÃ¨s simple qui charge vite
                glbUrl: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Triangle/glTF-Binary/Triangle.glb',
                scale: 0.5,
                positionY: 0.08,
                bridgeWidth: 0.1
            }
        };
        // ============================================================
        // REMPLACEZ CES URLs PAR LES VÃ”TRES QUAND VOUS AUREZ
        // DES FICHIERS .glb QUI FONCTIONNENT
        // ============================================================
        
        // Ã‰tat
        this.isRunning = false;
        this.currentModel = '1';
        this.faceModel = null;
        this.faceDetected = false;
        this.lastFrameTime = 0;
        this.frameCount = 0;
        this.fpsInterval = 0;
        
        // Three.js
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.currentGlasses = null;
        
        // Points du visage
        this.facePoints = {
            leftEye: null,
            rightEye: null,
            nose: null,
            faceCenter: null
        };
        
        // Calibration
        this.calibration = {
            offsetY: 0,
            scale: 1,
            bridgeWidth: 0.12
        };
        
        console.log('ðŸŽ¬ NWADRI - Initialisation...');
        this.init();
    }
    
    // ==================== INITIALISATION ====================
    async init() {
        // Taille canvas
        this.updateCanvasSize();
        
        // Ã‰vÃ©nements
        this.setupEventListeners();
        
        // Initialiser Three.js
        this.initThreeJS();
        
        // Charger TensorFlow.js
        await this.loadTensorFlowModels();
        
        console.log('âœ… NWADRI - PrÃªt !');
        this.showMessage('Cliquez sur DÃ©marrer pour commencer', 'info');
    }
    
    // ==================== TENSORFLOW.JS ====================
    async loadTensorFlowModels() {
        try {
            this.showLoading('Chargement IA de dÃ©tection faciale...');
            
            // Initialiser TensorFlow.js
            await tf.setBackend('webgl');
            await tf.ready();
            
            console.log('âœ… TensorFlow.js prÃªt');
            
            // Charger le modÃ¨le de dÃ©tection faciale
            this.faceModel = await faceLandmarksDetection.load(
                faceLandmarksDetection.SupportedPackages.mediapipeFacemesh,
                {
                    maxFaces: 1,
                    refineLandmarks: true,
                    detectionConfidence: 0.5
                }
            );
            
            this.hideLoading();
            console.log('âœ… ModÃ¨le facial chargÃ©');
            
        } catch (error) {
            console.error('âŒ Erreur TensorFlow:', error);
            this.hideLoading();
            this.showMessage('Erreur dÃ©tection faciale. Mode manuel activÃ©.', 'error');
            this.useManualMode();
        }
    }
    
    // ==================== THREE.JS ====================
    initThreeJS() {
        // ScÃ¨ne
        this.scene = new THREE.Scene();
        this.scene.background = null;
        
        // CamÃ©ra Three.js (orthographique pour superposition 2D/3D)
        const width = this.canvas.width;
        const height = this.canvas.height;
        
        this.camera = new THREE.OrthographicCamera(
            -width / 2, width / 2,
            height / 2, -height / 2,
            0.1, 1000
        );
        this.camera.position.z = 100;
        
        // Renderer
        this.renderer = new THREE.WebGLRenderer({
            canvas: this.canvas,
            alpha: true,
            antialias: true,
            premultipliedAlpha: false
        });
        this.renderer.setSize(width, height);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        this.renderer.setClearColor(0x000000, 0);
        
        // LumiÃ¨re
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        this.scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(1, 1, 1);
        this.scene.add(directionalLight);
        
        console.log('âœ… Three.js initialisÃ©');
    }
    
    // ==================== DÃ‰MARRER LA CAMÃ‰RA ====================
    async startCamera() {
        try {
            this.showLoading('DÃ©marrage camÃ©ra...');
            
            // ArrÃªter si dÃ©jÃ  en cours
            if (this.isRunning) {
                this.stopCamera();
            }
            
            // AccÃ©der Ã  la camÃ©ra frontale
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'user',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            });
            
            this.video.srcObject = stream;
            
            // Attendre que la vidÃ©o soit prÃªte
            await new Promise((resolve) => {
                this.video.onloadedmetadata = () => {
                    this.video.play();
                    resolve();
                };
            });
            
            // Ajuster la taille
            this.updateCanvasSize();
            
            // Charger les lunettes
            await this.loadGlasses();
            
            // DÃ©marrer la dÃ©tection
            this.isRunning = true;
            this.stats.style.display = 'block';
            document.getElementById('adjustControls').style.display = 'flex';
            this.startDetection();
            
            this.hideLoading();
            this.showMessage('âœ… Filtre activÃ© ! Les lunettes suivent votre visage', 'success');
            this.updateUI();
            
        } catch (error) {
            console.error('âŒ Erreur camÃ©ra:', error);
            this.hideLoading();
            this.showMessage('Erreur camÃ©ra: ' + error.message, 'error');
        }
    }
    
    stopCamera() {
        this.isRunning = false;
        
        if (this.video.srcObject) {
            this.video.srcObject.getTracks().forEach(track => track.stop());
            this.video.srcObject = null;
        }
        
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.stats.style.display = 'none';
        document.getElementById('adjustControls').style.display = 'none';
        
        if (this.currentGlasses) {
            this.scene.remove(this.currentGlasses);
            this.currentGlasses = null;
        }
        
        this.updateUI();
    }
    
    // ==================== CHARGEMENT .glb ====================
    async loadGlasses() {
        const modelInfo = this.models[this.currentModel];
        
        try {
            console.log('ðŸ“¦ Chargement lunettes:', modelInfo.glbUrl);
            
            const loader = new THREE.GLTFLoader();
            
            const gltf = await new Promise((resolve, reject) => {
                loader.load(
                    modelInfo.glbUrl,
                    (gltf) => {
                        console.log('âœ… Lunettes chargÃ©es');
                        resolve(gltf);
                    },
                    (progress) => {
                        const percent = Math.round(progress.loaded / progress.total * 100);
                        this.loadingText.textContent = `Chargement lunettes... ${percent}%`;
                    },
                    (error) => {
                        console.error('âŒ Erreur chargement:', error);
                        reject(error);
                    }
                );
            });
            
            const model = gltf.scene;
            
            // Optimiser le modÃ¨le
            model.traverse((child) => {
                if (child.isMesh) {
                    child.material.transparent = true;
                    child.material.depthWrite = false;
                    child.material.side = THREE.DoubleSide;
                    
                    // Pour les verres
                    if (child.name.toLowerCase().includes('glass') || 
                        child.name.toLowerCase().includes('lens')) {
                        child.material.opacity = 0.5;
                    }
                }
            });
            
            // Position initiale (sera ajustÃ©e par suivi facial)
            model.position.set(0, 0, 0);
            model.scale.setScalar(modelInfo.scale);
            
            // Ajouter Ã  la scÃ¨ne
            if (this.currentGlasses) {
                this.scene.remove(this.currentGlasses);
            }
            this.currentGlasses = model;
            this.scene.add(model);
            
            return model;
            
        } catch (error) {
            console.error('âŒ Erreur chargement, crÃ©ation modÃ¨le basique...');
            return this.createBasicGlasses();
        }
    }
    
    createBasicGlasses() {
        const group = new THREE.Group();
        
        // MatÃ©riaux
        const frameMat = new THREE.MeshBasicMaterial({
            color: 0x000000,
            transparent: true,
            opacity: 0.8
        });
        
        const lensMat = new THREE.MeshBasicMaterial({
            color: 0x1a5276,
            transparent: true,
            opacity: 0.4
        });
        
        // Cadres
        const leftFrame = new THREE.Mesh(
            new THREE.RingGeometry(30, 35, 16),
            frameMat
        );
        leftFrame.position.x = -40;
        
        const rightFrame = new THREE.Mesh(
            new THREE.RingGeometry(30, 35, 16),
            frameMat
        );
        rightFrame.position.x = 40;
        
        // Verres
        const leftLens = new THREE.Mesh(
            new THREE.CircleGeometry(30, 16),
            lensMat
        );
        leftLens.position.x = -40;
        
        const rightLens = new THREE.Mesh(
            new THREE.CircleGeometry(30, 16),
            lensMat
        );
        rightLens.position.x = 40;
        
        // Pont
        const bridge = new THREE.Mesh(
            new THREE.BoxGeometry(25, 3, 3),
            frameMat
        );
        
        group.add(leftFrame, rightFrame, leftLens, rightLens, bridge);
        group.scale.setScalar(0.5);
        
        this.currentGlasses = group;
        this.scene.add(group);
        
        return group;
    }
    
    // ==================== SUIVI FACIAL ====================
    async startDetection() {
        if (!this.isRunning) return;
        
        const now = Date.now();
        
        // Calculer FPS
        if (now - this.lastFrameTime >= 1000) {
            this.fps.textContent = this.frameCount;
            this.frameCount = 0;
            this.lastFrameTime = now;
        }
        this.frameCount++;
        
        try {
            // DÃ©tecter les visages avec TensorFlow.js
            const predictions = await this.faceModel.estimateFaces({
                input: this.video,
                returnTensors: false,
                flipHorizontal: false,
                predictIrises: true
            });
            
            // Effacer le canvas
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            
            if (predictions.length > 0) {
                // Visage dÃ©tectÃ© !
                this.faceDetected = true;
                this.faceStatus.textContent = 'âœ… DÃ©tectÃ©';
                this.faceStatus.style.color = '#4ECDC4';
                
                const landmarks = predictions[0].scaledMesh;
                
                // Extraire les points clÃ©s
                this.extractFacePoints(landmarks);
                
                // Positionner les lunettes sur le visage
                this.positionGlassesOnFace();
                
            } else {
                // Pas de visage dÃ©tectÃ©
                this.faceDetected = false;
                this.faceStatus.textContent = 'âŒ Non dÃ©tectÃ©';
                this.faceStatus.style.color = '#FF6B6B';
                
                // Cacher les lunettes
                if (this.currentGlasses) {
                    this.currentGlasses.visible = false;
                }
            }
            
        } catch (error) {
            console.error('Erreur dÃ©tection:', error);
        }
        
        // Rendu Three.js
        if (this.renderer && this.scene && this.camera) {
            this.renderer.render(this.scene, this.camera);
        }
        
        // Continuer la boucle
        requestAnimationFrame(() => this.startDetection());
    }
    
    extractFacePoints(landmarks) {
        // Les indices sont spÃ©cifiques Ã  MediaPipe Face Mesh
        // Yeux
        this.facePoints.leftEye = landmarks[33];   // Coin interne Å“il gauche
        this.facePoints.rightEye = landmarks[263]; // Coin interne Å“il droit
        
        // Nez
        this.facePoints.nose = landmarks[1];       // Bout du nez
        
        // Centre du visage (entre les yeux)
        this.facePoints.faceCenter = {
            x: (this.facePoints.leftEye[0] + this.facePoints.rightEye[0]) / 2,
            y: (this.facePoints.leftEye[1] + this.facePoints.rightEye[1]) / 2
        };
        
        // Calculer la distance entre les yeux
        const dx = this.facePoints.rightEye[0] - this.facePoints.leftEye[0];
        const dy = this.facePoints.rightEye[1] - this.facePoints.leftEye[1];
        this.calibration.bridgeWidth = Math.sqrt(dx * dx + dy * dy);
    }
    
    positionGlassesOnFace() {
        if (!this.currentGlasses || !this.faceDetected) return;
        
        const modelInfo = this.models[this.currentModel];
        
        // Rendre les lunettes visibles
        this.currentGlasses.visible = true;
        
        // Positionner au centre du visage
        const centerX = this.facePoints.faceCenter.x;
        const centerY = this.facePoints.faceCenter.y;
        
        // Convertir les coordonnÃ©es de la vidÃ©o au canvas
        const x = (centerX / this.video.videoWidth) * this.canvas.width;
        const y = (centerY / this.video.videoHeight) * this.canvas.height;
        
        // Convertir aux coordonnÃ©es Three.js
        const threeX = x - this.canvas.width / 2;
        const threeY = -(y - this.canvas.height / 2); // Y inversÃ©
        
        // Positionner les lunettes
        this.currentGlasses.position.x = threeX;
        this.currentGlasses.position.y = threeY + (modelInfo.positionY * 100) + this.calibration.offsetY;
        
        // Ajuster l'Ã©chelle selon la taille du visage
        const faceScale = this.calibration.bridgeWidth / 100;
        const finalScale = modelInfo.scale * faceScale * this.calibration.scale;
        this.currentGlasses.scale.setScalar(finalScale);
        
        // Ajuster la rotation selon l'orientation du visage
        const dx = this.facePoints.rightEye[0] - this.facePoints.leftEye[0];
        const dy = this.facePoints.rightEye[1] - this.facePoints.leftEye[1];
        const angle = Math.atan2(dy, dx);
        this.currentGlasses.rotation.z = -angle;
    }
    
    // ==================== CHANGER DE MODÃˆLE ====================
    async switchModel(modelId) {
        this.currentModel = modelId;
        
        // Recharger les lunettes
        await this.loadGlasses();
        
        this.showMessage(`ðŸ‘“ ${this.models[modelId].name}`);
    }
    
    // ==================== AJUSTEMENTS MANUELS ====================
    adjustGlasses(action) {
        if (!this.currentGlasses) return;
        
        switch (action) {
            case 'up':
                this.calibration.offsetY += 5;
                break;
            case 'down':
                this.calibration.offsetY -= 5;
                break;
            case 'bigger':
                this.calibration.scale *= 1.1;
                break;
            case 'smaller':
                this.calibration.scale *= 0.9;
                break;
            case 'reset':
                this.calibration.offsetY = 0;
                this.calibration.scale = 1;
                break;
        }
    }
    
    useManualMode() {
        // Mode de secours sans dÃ©tection faciale
        console.log('Mode manuel activÃ©');
        // Les lunettes seront positionnÃ©es manuellement
    }
    
    // ==================== UTILITAIRES ====================
    updateCanvasSize() {
        const container = document.querySelector('.ar-container');
        if (container) {
            this.canvas.width = container.clientWidth;
            this.canvas.height = container.clientHeight;
            
            if (this.renderer) {
                this.renderer.setSize(this.canvas.width, this.canvas.height);
                
                if (this.camera) {
                    this.camera.left = -this.canvas.width / 2;
                    this.camera.right = this.canvas.width / 2;
                    this.camera.top = this.canvas.height / 2;
                    this.camera.bottom = -this.canvas.height / 2;
                    this.camera.updateProjectionMatrix();
                }
            }
        }
    }
    
    setupEventListeners() {
        document.getElementById('startBtn').addEventListener('click', () => this.startCamera());
        document.getElementById('stopBtn').addEventListener('click', () => this.stopCamera());
        
        // Changer de modÃ¨le
        document.querySelectorAll('.model-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const modelId = btn.dataset.model;
                
                document.querySelectorAll('.model-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
                
                this.switchModel(modelId);
            });
        });
        
        // Ajustements
        document.querySelectorAll('.adj-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.currentTarget.dataset.action;
                this.adjustGlasses(action);
            });
        });
        
        // Redimensionnement
        window.addEventListener('resize', () => {
            this.updateCanvasSize();
        });
    }
    
    updateUI() {
        document.getElementById('startBtn').disabled = this.isRunning;
        document.getElementById('stopBtn').disabled = !this.isRunning;
    }
    
    showLoading(text) {
        if (this.loading && this.loadingText) {
            this.loadingText.textContent = text;
            this.loading.style.display = 'block';
        }
    }
    
    hideLoading() {
        if (this.loading) {
            this.loading.style.display = 'none';
        }
    }
    
    showMessage(text, type = 'info') {
        const oldMsg = document.querySelector('.message');
        if (oldMsg) oldMsg.remove();
        
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        msg.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${text}
        `;
        
        document.body.appendChild(msg);
        
        setTimeout(() => {
            if (msg.parentElement) msg.remove();
        }, 3000);
    }
    
    cleanup() {
        this.stopCamera();
        if (this.renderer) {
            this.renderer.dispose();
        }
    }
}

// ==================== DÃ‰MARRAGE ====================
document.addEventListener('DOMContentLoaded', () => {
    console.log('ðŸš€ NWADRI - Lancement...');
    
    // VÃ©rifier les APIs nÃ©cessaires
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Votre navigateur ne supporte pas l\'accÃ¨s Ã  la camÃ©ra.');
        return;
    }
    
    // DÃ©marrer l'application
    window.app = new NwadriGlassesFilter();
    
    // Nettoyage
    window.addEventListener('beforeunload', () => {
        if (window.app) {
            window.app.cleanup();
        }
    });
    
    console.log('ðŸ’¡ Commandes:');
    console.log('   app.startCamera() - DÃ©marrer');
    console.log('   app.switchModel("2") - Changer lunettes');
});
    </script>
</body>
</html>
