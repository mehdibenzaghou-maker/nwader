<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VTO | Virtual Sunglasses Try-On</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="assets/icons/favicon.ico">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.min.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/three@0.148.0/examples/js/loaders/GLTFLoader.min.js" as="script">
    
    <!-- iOS specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PWA -->
    <meta name="theme-color" content="#000000">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="spinner"></div>
            <h1>Virtual Try-On</h1>
            <p>Initializing AR experience...</p>
            <div class="loading-progress">
                <div class="progress-bar" id="progressBar"></div>
                <span id="progressText">0%</span>
            </div>
        </div>
    </div>

    <!-- Camera Permission Prompt -->
    <div class="permission-prompt" id="permissionPrompt">
        <div class="permission-content">
            <div class="permission-icon">üì∏</div>
            <h2>Camera Access Required</h2>
            <p>To try on sunglasses virtually, we need access to your camera. We process everything locally - no images are stored or sent to servers.</p>
            <button class="btn-primary" id="requestCamera">Allow Camera Access</button>
            <button class="btn-secondary" id="demoMode">Try Demo Mode</button>
            <p class="permission-note">Don't worry, you can change this later in your browser settings.</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <span class="logo-icon">üï∂Ô∏è</span>
                <span class="logo-text">VTO</span>
            </div>
            <div class="header-controls">
                <button class="icon-btn" id="toggleMirror" title="Mirror Camera">
                    <span>üîÑ</span>
                </button>
                <button class="icon-btn" id="toggleDebug" title="Debug Mode">
                    <span>üîß</span>
                </button>
            </div>
        </header>

        <!-- AR View Container -->
        <main class="ar-container">
            <!-- Camera Feed -->
            <div class="camera-feed" id="cameraFeed">
                <video class="camera-video" id="cameraVideo" autoplay playsinline muted></video>
                <canvas class="face-canvas" id="faceCanvas"></canvas>
                <canvas class="glasses-canvas" id="glassesCanvas"></canvas>
                
                <!-- Face Detection Guide -->
                <div class="face-guide" id="faceGuide">
                    <div class="guide-animation">
                        <div class="guide-circle"></div>
                        <div class="guide-dots">
                            <div class="dot dot-1"></div>
                            <div class="dot dot-2"></div>
                            <div class="dot dot-3"></div>
                        </div>
                    </div>
                    <p class="guide-text">Position your face here</p>
                </div>

                <!-- Status Overlay -->
                <div class="status-overlay" id="statusOverlay">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span class="status-text">Initializing...</span>
                    </div>
                </div>
            </div>

            <!-- Error States -->
            <div class="error-state" id="errorState">
                <div class="error-content">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h3>Camera Error</h3>
                    <p id="errorMessage">Unable to access camera. Please check permissions.</p>
                    <button class="btn-primary" id="retryCamera">Retry</button>
                </div>
            </div>

            <!-- Demo Mode -->
            <div class="demo-mode" id="demoModeView">
                <div class="demo-content">
                    <img src="assets/placeholder.jpg" alt="Demo face" class="demo-image">
                    <p class="demo-text">Demo Mode: Try glasses on this model</p>
                </div>
            </div>
        </main>

        <!-- Controls -->
        <footer class="app-footer">
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn-action primary" id="tryOnBtn">
                    <span class="btn-icon">üëì</span>
                    <span class="btn-text">Try On</span>
                </button>
                <button class="btn-action" id="captureBtn">
                    <span class="btn-icon">üì∏</span>
                    <span class="btn-text">Capture</span>
                </button>
                <button class="btn-action" id="resetBtn">
                    <span class="btn-icon">‚Ü∫</span>
                    <span class="btn-text">Reset</span>
                </button>
            </div>

            <!-- Glasses Carousel -->
            <div class="glasses-carousel">
                <div class="carousel-header">
                    <h3>Select Sunglasses</h3>
                    <div class="carousel-controls">
                        <button class="carousel-btn prev" id="carouselPrev">‚Äπ</button>
                        <button class="carousel-btn next" id="carouselNext">‚Ä∫</button>
                    </div>
                </div>
                
                <div class="carousel-track" id="carouselTrack">
                    <!-- Glasses items will be injected here -->
                </div>
            </div>
        </footer>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Screenshot Preview Modal -->
    <div class="modal" id="screenshotModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Your Look</h3>
                <button class="modal-close" id="closeModal">√ó</button>
            </div>
            <div class="modal-body">
                <canvas id="screenshotCanvas"></canvas>
                <div class="modal-actions">
                    <button class="btn-secondary" id="downloadBtn">Download</button>
                    <button class="btn-primary" id="shareBtn">Share</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Monitor (debug) -->
    <div class="performance-monitor" id="performanceMonitor">
        <div class="perf-item">FPS: <span id="fpsCounter">0</span></div>
        <div class="perf-item">Tracking: <span id="trackingStatus">-</span></div>
        <div class="perf-item">Models: <span id="modelCount">0</span></div>
    </div>

    <!-- Scripts (deferred for performance) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/examples/js/loaders/GLTFLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <!-- Main Application -->
    <script src="main.js" type="module"></script>
</body>
</html>
