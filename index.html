<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWADRI - Filtre Lunettes AR</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #000; color: white; }
        
        .container { padding: 15px; max-width: 100%; }
        
        header { text-align: center; padding: 15px; }
        .logo {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .btn {
            padding: 10px 20px;
            background: #4ECDC4;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-red { background: #FF6B6B; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .ar-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #video { width: 100%; height: auto; display: block; transform: scaleX(-1); }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
            border: 2px solid #4ECDC4;
        }
        
        .stats {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .model-grid {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .model-btn {
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .model-btn.active {
            border-color: #4ECDC4;
            background: rgba(78, 205, 196, 0.2);
        }
    </style>
    
    <!-- MediaPipe Face Mesh (SANS TensorFlow) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo">NWADRI</h1>
            <p style="color: #888; margin-bottom: 15px;">Filtre lunettes AR avec suivi facial</p>
            
            <div class="controls">
                <button id="startBtn" class="btn">
                    <i class="fas fa-play"></i> D√©marrer
                </button>
                <button id="stopBtn" class="btn btn-red" disabled>
                    <i class="fas fa-stop"></i> Arr√™ter
                </button>
            </div>
        </header>
        
        <div class="ar-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
            
            <div id="loading" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <p id="loadingText">Chargement...</p>
            </div>
            
            <div class="stats" id="stats">
                <div>√âtat: <span id="status">Pr√™t</span></div>
                <div>Visage: <span id="faceStatus" style="color: #FF6B6B;">‚ùå Non d√©tect√©</span></div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <div class="model-grid">
                <button class="model-btn active" data-model="1">üëì Classic</button>
                <button class="model-btn" data-model="2">üï∂Ô∏è Aviator</button>
                <button class="model-btn" data-model="3">‚ú® Premium</button>
            </div>
        </div>
    </div>

    <script>
// ============================================================
// NWADRI - MediaPipe Face Mesh (GARANTI de d√©tecter les visages)
// ============================================================

class NwadriFaceFilter {
    constructor() {
        // √âl√©ments
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.loading = document.getElementById('loading');
        this.loadingText = document.getElementById('loadingText');
        this.faceStatus = document.getElementById('faceStatus');
        this.status = document.getElementById('status');
        
        // ============================================================
        // MOD√àLES .glb QUI FONCTIONNENT
        // ============================================================
        this.models = {
            '1': {
                name: 'Classic Glasses',
                // Mod√®le SIMPLE qui charge vite
                glbUrl: 'https://pub-72b1924cc2494065a2af6bf69f360686.r2.dev/Nwader.glb',
                scale: 0.8,
                positionY: 0.12
            },
            '2': {
                name: 'Aviator Style',
                glbUrl: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Triangle/glTF-Binary/Triangle.glb',
                scale: 0.6,
                positionY: 0.1
            },
            '3': {
                name: 'Premium Glasses',
                glbUrl: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Box/glTF-Binary/Box.glb',
                scale: 1.0,
                positionY: 0.15
            }
        };
        // ============================================================
        // QUAND VOUS AVEZ VOS FICHIERS .glb, REMPLACEZ LES URLs
        // ============================================================
        
        // √âtat
        this.isRunning = false;
        this.currentModel = '1';
        this.faceDetected = false;
        this.faceMesh = null;
        this.faceLandmarks = null;
        
        // Three.js
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.currentGlasses = null;
        
        // Points du visage
        this.facePoints = {
            leftEye: null,
            rightEye: null,
            nose: null,
            center: null
        };
        
        console.log('üé¨ NWADRI - Initialisation...');
        this.init();
    }
    
    // ==================== INITIALISATION ====================
    async init() {
        // Taille canvas
        this.updateCanvasSize();
        
        // √âv√©nements
        this.setupEventListeners();
        
        // Initialiser Three.js
        this.initThreeJS();
        
        console.log('‚úÖ NWADRI - Pr√™t !');
    }
    
    // ==================== M√âDIAPIPE FACE MESH ====================
    async startFaceDetection() {
        try {
            this.showLoading('Initialisation d√©tection faciale...');
            
            // Cr√©er l'instance Face Mesh
            this.faceMesh = new FaceMesh({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }
            });
            
            // Configuration
            this.faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            // Callback quand un visage est d√©tect√©
            this.faceMesh.onResults((results) => {
                this.onFaceResults(results);
            });
            
            // D√©marrer la cam√©ra
            await this.startCamera();
            
            this.hideLoading();
            this.status.textContent = 'D√©tection active';
            this.status.style.color = '#4ECDC4';
            
        } catch (error) {
            console.error('‚ùå Erreur MediaPipe:', error);
            this.hideLoading();
            this.showError('Erreur d√©tection faciale');
        }
    }
    
    async startCamera() {
        try {
            this.showLoading('D√©marrage cam√©ra...');
            
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'user',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            });
            
            this.video.srcObject = stream;
            
            await new Promise((resolve) => {
                this.video.onloadedmetadata = () => {
                    this.video.play();
                    resolve();
                };
            });
            
            // Ajuster la taille
            this.updateCanvasSize();
            
            // Charger les lunettes
            await this.loadGlasses();
            
            // D√©marrer MediaPipe
            const camera = new Camera(this.video, {
                onFrame: async () => {
                    await this.faceMesh.send({ image: this.video });
                },
                width: 640,
                height: 480
            });
            
            camera.start();
            this.isRunning = true;
            this.updateUI();
            
            this.hideLoading();
            this.showMessage('‚úÖ Filtre activ√© !');
            
        } catch (error) {
            console.error('‚ùå Erreur cam√©ra:', error);
            this.hideLoading();
            this.showError('Erreur cam√©ra: ' + error.message);
        }
    }
    
    onFaceResults(results) {
        // Effacer le canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            // Visage d√©tect√© !
            this.faceDetected = true;
            this.faceStatus.textContent = '‚úÖ D√©tect√©';
            this.faceStatus.style.color = '#4ECDC4';
            
            const landmarks = results.multiFaceLandmarks[0];
            this.faceLandmarks = landmarks;
            
            // Extraire les points du visage
            this.extractFacePoints(landmarks);
            
            // Dessiner les points (optionnel, pour d√©bogage)
            this.drawFaceLandmarks(landmarks);
            
            // Positionner les lunettes
            this.positionGlassesOnFace();
            
        } else {
            // Pas de visage
            this.faceDetected = false;
            this.faceStatus.textContent = '‚ùå Non d√©tect√©';
            this.faceStatus.style.color = '#FF6B6B';
            
            if (this.currentGlasses) {
                this.currentGlasses.visible = false;
            }
        }
        
        // Rendu Three.js
        if (this.renderer && this.scene && this.camera) {
            this.renderer.render(this.scene, this.camera);
        }
    }
    
    extractFacePoints(landmarks) {
        // MediaPipe Face Mesh a 468 points
        // Indices pour les yeux et le nez
        const LEFT_EYE = 33;      // Coin interne ≈ìil gauche
        const RIGHT_EYE = 263;    // Coin interne ≈ìil droit
        const NOSE_TIP = 1;       // Bout du nez
        
        this.facePoints.leftEye = landmarks[LEFT_EYE];
        this.facePoints.rightEye = landmarks[RIGHT_EYE];
        this.facePoints.nose = landmarks[NOSE_TIP];
        
        // Centre entre les yeux
        this.facePoints.center = {
            x: (this.facePoints.leftEye.x + this.facePoints.rightEye.x) / 2,
            y: (this.facePoints.leftEye.y + this.facePoints.rightEye.y) / 2
        };
    }
    
    drawFaceLandmarks(landmarks) {
        // Dessiner les points du visage (pour voir si √ßa d√©tecte)
        this.ctx.fillStyle = '#4ECDC4';
        
        // Dessiner les yeux
        this.ctx.beginPath();
        this.ctx.arc(
            this.facePoints.leftEye.x * this.canvas.width,
            this.facePoints.leftEye.y * this.canvas.height,
            3, 0, Math.PI * 2
        );
        this.ctx.fill();
        
        this.ctx.beginPath();
        this.ctx.arc(
            this.facePoints.rightEye.x * this.canvas.width,
            this.facePoints.rightEye.y * this.canvas.height,
            3, 0, Math.PI * 2
        );
        this.ctx.fill();
        
        // Dessiner le nez
        this.ctx.fillStyle = '#FF6B6B';
        this.ctx.beginPath();
        this.ctx.arc(
            this.facePoints.nose.x * this.canvas.width,
            this.facePoints.nose.y * this.canvas.height,
            4, 0, Math.PI * 2
        );
        this.ctx.fill();
    }
    
    // ==================== THREE.JS ====================
    initThreeJS() {
        // Sc√®ne
        this.scene = new THREE.Scene();
        this.scene.background = null;
        
        // Cam√©ra
        const width = this.canvas.width;
        const height = this.canvas.height;
        
        this.camera = new THREE.OrthographicCamera(
            -width / 2, width / 2,
            height / 2, -height / 2,
            0.1, 1000
        );
        this.camera.position.z = 100;
        
        // Renderer
        this.renderer = new THREE.WebGLRenderer({
            canvas: this.canvas,
            alpha: true,
            antialias: true
        });
        this.renderer.setSize(width, height);
        this.renderer.setClearColor(0x000000, 0);
        
        // Lumi√®re
        const light = new THREE.AmbientLight(0xffffff, 0.8);
        this.scene.add(light);
        
        console.log('‚úÖ Three.js initialis√©');
    }
    
    async loadGlasses() {
        const modelInfo = this.models[this.currentModel];
        
        try {
            console.log('Chargement:', modelInfo.glbUrl);
            
            const loader = new THREE.GLTFLoader();
            
            const gltf = await new Promise((resolve, reject) => {
                loader.load(
                    modelInfo.glbUrl,
                    resolve,
                    undefined,
                    reject
                );
            });
            
            const model = gltf.scene;
            
            // Optimiser
            model.traverse((child) => {
                if (child.isMesh) {
                    child.material.transparent = true;
                    child.material.depthWrite = false;
                    child.material.side = THREE.DoubleSide;
                }
            });
            
            // Position initiale
            model.position.set(0, 0, 0);
            model.scale.setScalar(modelInfo.scale);
            
            // Ajouter √† la sc√®ne
            if (this.currentGlasses) {
                this.scene.remove(this.currentGlasses);
            }
            this.currentGlasses = model;
            this.scene.add(model);
            
            console.log('‚úÖ Lunettes charg√©es');
            
        } catch (error) {
            console.error('Erreur chargement, cr√©ation mod√®le basique...');
            this.createBasicGlasses();
        }
    }
    
    createBasicGlasses() {
        const group = new THREE.Group();
        
        // Mat√©riaux
        const frameMat = new THREE.MeshBasicMaterial({
            color: 0x000000,
            transparent: true,
            opacity: 0.8
        });
        
        const lensMat = new THREE.MeshBasicMaterial({
            color: 0x1a5276,
            transparent: true,
            opacity: 0.4
        });
        
        // Cadres
        const leftFrame = new THREE.Mesh(
            new THREE.RingGeometry(25, 30, 16),
            frameMat
        );
        leftFrame.position.x = -35;
        
        const rightFrame = new THREE.Mesh(
            new THREE.RingGeometry(25, 30, 16),
            frameMat
        );
        rightFrame.position.x = 35;
        
        // Verres
        const leftLens = new THREE.Mesh(
            new THREE.CircleGeometry(25, 16),
            lensMat
        );
        leftLens.position.x = -35;
        
        const rightLens = new THREE.Mesh(
            new THREE.CircleGeometry(25, 16),
            lensMat
        );
        rightLens.position.x = 35;
        
        // Pont
        const bridge = new THREE.Mesh(
            new THREE.BoxGeometry(20, 3, 3),
            frameMat
        );
        
        group.add(leftFrame, rightFrame, leftLens, rightLens, bridge);
        group.scale.setScalar(0.4);
        
        this.currentGlasses = group;
        this.scene.add(group);
    }
    
    positionGlassesOnFace() {
        if (!this.currentGlasses || !this.faceDetected) return;
        
        const modelInfo = this.models[this.currentModel];
        
        // Rendre visible
        this.currentGlasses.visible = true;
        
        // Positionner sur le visage
        const centerX = this.facePoints.center.x * this.canvas.width;
        const centerY = this.facePoints.center.y * this.canvas.height;
        
        // Convertir aux coordonn√©es Three.js
        const threeX = centerX - this.canvas.width / 2;
        const threeY = -(centerY - this.canvas.height / 2); // Y invers√©
        
        // Position
        this.currentGlasses.position.x = threeX;
        this.currentGlasses.position.y = threeY + (modelInfo.positionY * 100);
        
        // Rotation selon orientation du visage
        const dx = this.facePoints.rightEye.x - this.facePoints.leftEye.x;
        const dy = this.facePoints.rightEye.y - this.facePoints.leftEye.y;
        const angle = Math.atan2(dy, dx);
        this.currentGlasses.rotation.z = -angle;
    }
    
    // ==================== UTILITAIRES ====================
    updateCanvasSize() {
        const container = document.querySelector('.ar-container');
        if (container) {
            this.canvas.width = container.clientWidth;
            this.canvas.height = container.clientHeight;
            
            if (this.renderer) {
                this.renderer.setSize(this.canvas.width, this.canvas.height);
                
                if (this.camera) {
                    this.camera.left = -this.canvas.width / 2;
                    this.camera.right = this.canvas.width / 2;
                    this.camera.top = this.canvas.height / 2;
                    this.camera.bottom = -this.canvas.height / 2;
                    this.camera.updateProjectionMatrix();
                }
            }
        }
    }
    
    setupEventListeners() {
        document.getElementById('startBtn').addEventListener('click', () => {
            this.startFaceDetection();
        });
        
        document.getElementById('stopBtn').addEventListener('click', () => {
            this.stopCamera();
        });
        
        // Changer de mod√®le
        document.querySelectorAll('.model-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const modelId = btn.dataset.model;
                
                document.querySelectorAll('.model-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
                
                this.switchModel(modelId);
            });
        });
        
        window.addEventListener('resize', () => {
            this.updateCanvasSize();
        });
    }
    
    async switchModel(modelId) {
        this.currentModel = modelId;
        await this.loadGlasses();
    }
    
    stopCamera() {
        this.isRunning = false;
        
        if (this.video.srcObject) {
            this.video.srcObject.getTracks().forEach(track => track.stop());
            this.video.srcObject = null;
        }
        
        if (this.faceMesh) {
            this.faceMesh.close();
        }
        
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.updateUI();
    }
    
    updateUI() {
        document.getElementById('startBtn').disabled = this.isRunning;
        document.getElementById('stopBtn').disabled = !this.isRunning;
    }
    
    showLoading(text) {
        if (this.loading && this.loadingText) {
            this.loadingText.textContent = text;
            this.loading.style.display = 'block';
        }
    }
    
    hideLoading() {
        if (this.loading) {
            this.loading.style.display = 'none';
        }
    }
    
    showMessage(text) {
        alert(text); // Simple pour l'instant
    }
    
    showError(text) {
        alert('Erreur: ' + text);
    }
}

// ==================== D√âMARRAGE ====================
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ NWADRI - Lancement...');
    
    // V√©rifier MediaPipe
    if (typeof FaceMesh === 'undefined') {
        alert('Erreur: MediaPipe non charg√©. V√©rifiez votre connexion internet.');
        return;
    }
    
    // D√©marrer
    window.app = new NwadriFaceFilter();
});
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
